<script src="../dist/browser/tfjs-onnx.js"></script>
<script src="ILSVRC2012.js"></script>

<canvas id="img"></canvas>
<div id="result"></div>

<script>
  function loadImageData(img, shape) {
    const pixels = tf.fromPixels(img);
    const data = tf.image.resizeBilinear(pixels, shape);
    return data.expandDims().cast('float32');
  }

  function displayImage(data, elemId) {
    const elem = document.getElementById(elemId);
    const pixels = tf.squeeze(data).div(tf.scalar(255));
    tf.toPixels(pixels, elem);
  }

  function displayLabel(label, elemId) {
    const elem = document.getElementById(elemId);
    elem.textContent = label;
  }

  (async function(){
    // Load the image
    const imgElem = document.getElementById('img');
    const imgUrl = 'img/cat.jpg';
    const img = await tf.onnx.util.loadImageData(imgUrl);

    // Load the model
    const modelUrl = 'models/squeezenet-onnx/model.onnx'
    const model = await tf.onnx.loadModel(modelUrl);
    console.debug(model);

    // Load the pixel and scale to model input
    const data = loadImageData(img, [224, 224]);

    // Visualize image
    displayImage(data, 'img');

    const predictedClass = tf.tidy(() => {

      // Perform the forward pass
      const predictions = model.predict(data);

      // Return the highest column id
      return predictions.as1D().argMax();
    });

    // Output the result
    const classId = (await predictedClass.data())[0];
    const className = IMAGENET_CLASSES[classId];
    displayLabel(className, 'result');
  })();
</script>
